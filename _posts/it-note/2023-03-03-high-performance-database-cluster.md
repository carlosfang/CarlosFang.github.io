---
layout: post
title: 高性能数据库集群
date: 2023-03-03 10:12:15
categories: 系统设计
tags: 极客时间 技术学习笔记 mysql
excerpt: 架构师通过数据库集群来提高数据库的性能如：读写分离和分库分表
---


数据库厂商在数据库的高性能上做了多的优化和提升。但无法满足各行各业的业务发展。 

所以，架构师通过数据库集群来提高数据库的性能。这里有两种方式： **读写分离和分库分表**。

# 一、读写分离

### 读写分离原理

读写分离的基本原理是将数据库读写操作分散到不同的节点为上。如下图：

![](/assets/system-design/architecture-design-2023-03-16-22-07-54.png)

说明：

1、数据库服务器集群配置有主从，一主多从。

2、数据库主机负责读写操作，从机只负责读操作。（从机的读时，极端情况数据可能存在不一致的情况）

3、数据库主机通过复制将数据同步到从机。主从机的所有数据都是一致的。 

### 复制延迟

上面说到极端情况数据可能存在不一致的情况，就是复制延迟引起的。 以MySQL 为例，主从复制延迟可能达到1秒。

业务上场景是：程序将数据写入数据库后，马上又进行读取，这时数据还是从主机同步人机，此时读从机就无法读最新的数据。

解决这个问题的方法是：

1、写操作后读操作指定到数据库主机上读。 

2、读从机失败后，再读一次主机。（如果只是数据没有更新，则不会读失败，只会读到最新数据）

3、关键业务读写操作全部指向主机，非关系业务采用读写分离的方式。

### 分配机制

将读写操作区分开来，然后访问不同的数据库服务，一般有两种方式：程序代码封闭和中间件。 

**程序代码封装**

在程序代码中封装一个抽象数据访问层，实现读写操作分离和数据库服务连接的管理。这个访问层是被编译到程序当中的。

这种代码封装的方式有几个特点：

1、实现简单，贴近业务，可以做较多定制化的功能。

2、不同的开发语言要有不同的实现，重复开发。 

3、故障进，主从发生切换，对应的服务重启。 

开源的实现方案中： 淘宝的 TDDL（Taobao Distributed Data Layer）。 

**中间件封装**

中间件是独立的服务，实现读写操作分离和数据服务器连接的管理。 中间件服务提供SQL 兼容协议，业务程序不用自己进行读写分离，访问中间件和访问数据库没有区别。基本架构如下：

![](/assets/system-design/architecture-design-2023-03-16-22-42-53.png)

数据库中间件的方式具备的特点是：

1、提供标准的SQL接口，所以和编程语言无关。 

2、比较复杂，需要支持完整的SQL 语法和数据库协议。 

3、对中间件的性能要求高，在业务程序和数据库中加了一层，多一些性能上的消耗。 

4、数据库主从切换对业务程序无感知。

奇虎360 开源了数据库中间件Atas。



# 二 分库分表

读写分离可以分散数据库读写操作的压力，但没有分散存储压力，当数据量达到千万甚至上亿条的时候，单台数据库服务器的存储能力会成为系统瓶颈。表现为：

- 数据量大，读写的性能会下降，即使有索引，索引也会变得很大，性能同样下降。
- 数据文件变得很大，数据库备份和恢复需要耗费很长时间。 
- 数据文件越大，极端情况下丢失败的数据的风险越高。 



### 业务分库

业务分库指的是按照业务模块将数据分散到不同的数据库服服务器。如电商业务可以把用户、商品、订单三个业务模块分到不同数据库上。 

业务分库能够分散存储和访问压力，同时也带来问题：

1、join 操作。分库后，相关的join 操作无法使用 。

2、事务问题。数据库的事务无法使用。只能要代码层面保证事务。 

3、成本问题。服务库服务器多了，连接数据也复杂了。

### 分表方案

单表数据拆分有两种方式： 垂直分表和水平分表。

![](/assets/system-design/architecture-design-2023-03-17-00-10-13.png)

分表后，多个表存在同一个数据库服务中，也可以带来不的性能提升。当然也可以放在不同的数据库服务中。

分表能够有效地分散存储压力和琮来性能提升。同样也会引放各种复杂性问题。 

**垂直分表**

垂直分表适合将表中某些不常用且占了大量空间的列拆分出去。如前面图中： nickname 和 description 字段。

垂直分表的引入的复杂性主要体现在表操作的数据要增加。 

**水平分表**

水平分表适合数特别大的表。 例如：单表行数超过 5000W。当看到表的数据量达到千万级别时，就是警觉起来，考虑架构的性能瓶颈或者隐患。

水平分表后，数据应该放到哪一张中，就是需要进行路由分配， 一般都是某个业务ID进行hash 。 

常风的路由算法有：

- 范围路由：选取有序的数据列（如时间，ID等）作为路由的条件。不同范围放到不表中。 优点是可以随着数据的增加扩展比较方便。 缺点是数据不均衡。 
- Hash 路由：选取某个表（或者某几个列组也可以）的值进行 hash 运算。如 ID % 1024 ， 分为1024张表。 优点是数据比较均衡。 缺点是扩充新的表比较麻烦。

----
1、《从零开始学架构》 李运华





