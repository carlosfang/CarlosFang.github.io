---
layout: post
title: 存储架构双机架构
date: 2023-03-05 10:12:15
categories: 系统设计
tags: 极客时间 技术学习笔记 
excerpt: 见的高可用存储架构有：主备、主从、双机、主主、集群、分区
---
存储高可用的方案本质上就是通过数据冗余的方式来实现的。 方案的重点是：数据的复制、数据的一致性。

可以通过下面几方式来分析：

- 数据如何复制？
- 节点的职责是什么？
- 如何应对复制延迟？
- 如果应对复制中断？

常见的高可用存储架构有：主备、主从、双机、主主、集群、分区。 

# 主备复制

标准的主备方案结构图：

![](/assets/system-design/architecture-design-2023-03-20-13-15-51.png)

这个架构中备机主要的功能是数据备份。 并不参与实现的业务功能。 切换需要人工手动进行。 

主备复制架构的优点是：简单。特点是： 客户端不感知备机存在，备机只是备份数据，不参考业务； 故障后要人工切换。

场景：内部的后管理系统用主备复制架构比较多，主要是因为这类系统数据更新频率比较低。

# 主从复制

标准主从复制架构图如下：

![](/assets/system-design/architecture-design-2023-03-20-13-21-52.png)

主机是可读也可写，从机只可读。

优点：

- 主机故障后，不影响从机的读。 
- 从机提供了读功能，参与到业务功能去，提高系统的性能。

缺点：

- 客户端读写时要感知主机还是备机。
- 如果主从数据复制延迟比较大，则可能会影响从机的读操作的数据一致性。 
- 故障旱需要人工干预。

场景：适合一些读多写少的场景。如论坛，新闻网点等，读写比在 10倍到100倍之间。 

# 双机切换

双机切换是在上面两个种方式上增加了自动切换的功能。

关键的设计点：

- 主备间状态判断。状态传递的渠道，以及状态检测的内容。 检测是否掉电、进程是否存在、响应是否缓慢等。
- 切换决策。切换时机、切换策略、自动程度。
- 解决数据冲突。 故障的主机恢复之后，可能存在数据冲突。应该如何处理。

常见的架构：有互连式、中介式、模拟式。 

感觉双机主动切换，在实际应该中可能会出现很多问题。切换的时机，数据的一致性是一个很大的考验。不知道生产环境有没有企业真实的运用到。 

# 主主复制

主主复制是两台机器都是主机，双方都要把数据复制给对方，客户端可以任意挑其中一台机器进行读写操作。如下：

![](/assets/system-design/architecture-design-2023-03-20-14-03-28.png)

特点：

- 两台都是主机，不存在切换。
- 客户端读写其中一台主机即可。

对数据的设计有严格有要求，一般适合于临时性、可丢失、可覆盖的数据场景。

# 数据集群

集群就是多台机器组全在一起形成一个统一的系统。主要是解决主备、主从架构的存储或处理能力不足的问题。集群可以根据不同业务来划分不同数据角色。 

主要可以分两大类：数据集中集群，数据分散集群。 

### 数据集中集群

这种方式和主备、主从架构相似。 如下图：

![](/assets/system-design/architecture-design-2023-03-20-14-42-30.png)

集群中的服务器比较多，所以复杂度会更高一些，表现为：

- 主机如何将数据复制给备机
- 主要故障后，如何决定新的主机，如Zoobeeper 通过 ZAB 的算法来解决。 

数据集中集群，客户端只能将数据写到主机。 

### 数据分散集群

是指多个服务器给成一个集群。每台服务器都负责存储一部分数据。数据分散集群的复杂点在于如何将数据分配到不同的服务器上。 算法的考量如下：

- 均衡性
- 容错性
- 可伸缩性

数据分散集群中的每台服务器都可以处理读写请求。需要一台服务器来负责执行数据分配算法，可以是独立一台服务器也可以是选举出来的一台机器来承担。

# 数据分区

前面的架构设计主要是考虑部分硬件出现故障问题，数据依然可用。 但是如果大面积出现故障，如一个机房出现问题了，如火灾等。这里这个机房中的所有集群的机器都可能会有故障。 

我们可以通过设计地理级别的数据分区来解决这样的问题。 

数据分区是将数据按一定的规则进行分区，不同分区分布上在不地域上，每个分区存储一部分，分区之前可以相互备份数据。这样一个地域发生事故时，可以通过另一个地域的机房的数据同步恢复数据。 

数据分区架构，要考虑的有：

1、数据量

​	数据量大小直接决定了分区的规则和复杂度。数据服务器越多，单机的故障就会越常见。所以运维成本也更加复杂。

2、分区规则

地理位置，有远有近，分不同省市，考虑地域的安全性。业务范围，成本等。

3、复制规则

数据的一致性是最重要的核心。所以复制方式一定是一个高可用的方案。 

常见的分区复制规则有三种： 集中式、互备式、独立式。

### 集中式

集中式备份指存在一个总的备份中心，所有的分区都将数据备份到备份中心，如下：

![](/assets/system-design/architecture-design-2023-03-20-15-21-52.png)

特点：

- 扩展容易，可以随时增加一个分区
- 成本高，需要一个独立的备份中心

### 互备式

每一个分区是另一个分区的数据备份。如下：

![](/assets/system-design/architecture-design-2023-03-20-15-24-01.png)

特点：

- 设计复杂，分区既要承担数据存储功能，也要承担数据备份功能。
- 扩展麻烦，相互备份的相关扩展越来比较麻烦
- 成本低，无需独立备份中心，

### 独立式

每个分区都有自己的独立的备份中心，如下：

![](/assets/system-design/architecture-design-2023-03-20-15-27-35.png)

特点：

- 设计简单，各分区互不影响
- 扩展性好，新增比较简单快捷
- 成本高

-----

1、《从零开始学架构》 李运华

