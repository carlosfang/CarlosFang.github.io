<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>linux 进程间通信-共享内存</title>

    <meta name="viewport" content="width=device-width">
    <meta name="description" content="">

    
    

    <link rel="canonical" href="http://localhost:4000/linux-process-shm">
    <link rel="icon" type="image/png" href="/images/logo.png">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/monster.css">

    

</head>


    <body>
    
    <div class="wrapper">

      <header class="header">

  <div class="site-title">
    
    <h4 class="entry-title"><a href="/linux-process-shm">linux 进程间通信-共享内存</a></h4>
    
  </div>

<div class="links">
    
    <a href="/" class="page-link">Blog</a>
    
    
    
    
      <a class="page-link"
        href="/about/">About</a>
    
    
    
      <a class="page-link"
        href="/categories">Categories</a>
    
    
    
    
    
    
    
      <a class="page-link"
        href="/links/">Links</a>
    
    
    
    
    
      <a class="page-link"
        href="/tags">Tags</a>
    
    
    <a href="/feed.xml" target="_blank" class="page-link">RSS</a>
</div>
</header>

      
      <div class="navi">
    
    <a href="/" class="page-link">Blog</a>
    
    
    
    
      <a class="page-link"
        href="/about/">About</a>
    
    
    
      <a class="page-link"
        href="/categories">Categories</a>
    
    
    
    
    
    
    
      <a class="page-link"
        href="/links/">Links</a>
    
    
    
    
    
      <a class="page-link"
        href="/tags">Tags</a>
    
    
    <a href="/feed.xml" target="_blank" class="page-link">RSS</a>
</div>


      <div class="content">
        <div class="articles">
            <div class="article-meta">
    2014-10-13
     • Category: 
        
        <a href="/categories/#Linux-ref" >Linux</a>
        
    
     • Tag: 
        
            <a href="/tags/#系统编程-ref" >系统编程</a>
        
    
</div>


<div class="entry post">

	<div class="entry-content">
	  <article class="entry-body">
	  	
	  		<h3 id="一-共享内存介绍">一 共享内存介绍</h3>

<p>共享内存可以从字面上去理解，就把一片逻辑内存共享出来，让不同的进程去访问它，修改它。共享内存是在两个正在运行的进程之间共享和传递数据的一种非常有效的方式。不同进程之间共享的内存通常安排为同一段物理内存。进程可以将同一段共享内存连接到它们自己的地址空间中，所有进程都可以访问共享内存中的地址，就好像它们是由用C语言函数malloc分配的内存一样。而如果某个进程向共享内存写入数据，所做的改动将立即影响到可以访问同一段共享内存的任何其他进程。
但有一点特别要注意：共享内存并未提供同步机制。也就是说，在第一个进程结束对共享内存的写操作之前，并无自动机制可以阻止第二个进程开始对它进行读取。所以我们通常需要用其他的机制来同步对共享内存的访问，例如信号量。</p>

<h3 id="二-共享内存的使用">二 共享内存的使用</h3>

<p>(1)创建共享内存</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kt">int</span> <span class="nf">shmget</span><span class="p">(</span><span class="n">key_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shmflg</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>key共享内存段的命名，shmget函数成功时返回一个与key相关的共享内存标识符（非负整数），用于后续的共享内存函数。调用失败返回-1.其它的进程可以通过该函数的返回值访问同一共享内存，它代表进程可能要使用的某个资源，程序对所有共享内存的访问都是间接的，程序先通过调用shmget函数并提供一个键，再由系统生成一个相应的共享内存标识符（shmget函数的返回值），只有shmget函数才直接使用信号量键，所有其他的信号量函数使用由semget函数返回的信号量标识符。</li>
  <li>size以字节为单位指定需要共享的内存容量。</li>
  <li>shmflg是权限标志，它的作用与open函数的mode参数一样，如果要想在key标识的共享内存不存在时，创建它的话，可以与IPC_CREAT做或操作。共享内存的权限标志与文件的读写权限一样，举例来说，0644,它表示允许一个进程创建的共享内存被内存创建者所拥有的进程向共享内存读取和写入数据，同时其他用户创建的进程只能读取共享内存。</li>
</ul>

<p>(2)启动对该共享内存的访问</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="nf">shmat</span><span class="p">(</span><span class="kt">int</span> <span class="n">shm_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">shm_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shmflg</span><span class="p">);</span>
</code></pre></div></div>

<p>第一次创建完共享内存时，它还不能被任何进程访问，shmat函数的作用就是用来启动对该共享内存的访问，并把共享内存连接到当前进程的地址空间。</p>
<ul>
  <li>shm_id是由shmget函数返回的共享内存标识。</li>
  <li>shm_addr指定共享内存连接到当前进程中的地址位置，通常为空，表示让系统来选择共享内存的地址。</li>
  <li>shm_flg是一组标志位，通常为0。
调用成功时返回一个指向共享内存第一个字节的指针，如果调用失败返回-1.</li>
</ul>

<p>(3)将共享内存从当前进程中分离</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">shmdt</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">shmaddr</span><span class="p">);</span>
</code></pre></div></div>

<p>该函数用于将共享内存从当前进程中分离。注意，将共享内存分离并不是删除它，只是使该共享内存对当前进程不再可用。</p>
<ul>
  <li>shmaddr是shmat函数返回的地址指针，调用成功时返回0，失败时返回-1。</li>
</ul>

<p>(4)控制共享内存</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">shmctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">shm_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span> <span class="k">struct</span> <span class="n">shmid_ds</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
</code></pre></div></div>

<p>shm_id是shmget函数返回的共享内存标识符。
command是要采取的操作，它可以取下面的三个值 ：
 *IPC_STAT：把shmid_ds结构中的数据设置为共享内存的当前关联值，即用共享内存的当前关联值覆盖shmid_ds的值。
 *IPC_SET：如果进程有足够的权限，就把共享内存的当前关联值设置为shmid_ds结构中给出的值
 *IPC_RMID：删除共享内存段
buf是一个结构指针，它指向共享内存模式和访问权限的结构。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">shmid_ds</span>
<span class="p">{</span>
     <span class="n">uid_t</span> <span class="n">shm_perm</span><span class="p">.</span><span class="n">uid</span><span class="p">;</span>
     <span class="n">uid_t</span> <span class="n">shm_perm</span><span class="p">.</span><span class="n">gid</span><span class="p">;</span>
     <span class="n">mode_t</span> <span class="n">shm_perm</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
<span class="err">｝</span>
</code></pre></div></div>

<h3 id="三-例子">三 例子</h3>

<p>shmdata.h的源码:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifndef _SHMDATA_H_HEADER
#define _SHMDATA_H_HEADER
#define TEXT_SZ 2048
</span>
<span class="k">struct</span> <span class="n">shared_use_st</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">written</span><span class="p">;</span><span class="cm">/* 作为一个标志，非0：表示可读，0表示可写 */</span>
    <span class="kt">char</span> <span class="n">text</span><span class="p">[</span><span class="n">TEXT_SZ</span><span class="p">];</span><span class="cm">/* 记录写入和读取的文本 */</span>
<span class="p">};</span>

<span class="cp">#endif
</span></code></pre></div></div>

<p>shmread.c的源代码</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/shm.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"shmdata.h"</span><span class="cp">
</span>
<span class="cp">#define MEM_KEY      (1234)
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>             <span class="c1">//程序是否继续运行的标志</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">shm</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>          <span class="c1">//分配的共享内存的原始首地址</span>
    <span class="k">struct</span> <span class="n">shared_use_st</span> <span class="o">*</span><span class="n">shared</span><span class="p">;</span><span class="c1">//指向shm</span>
    <span class="kt">int</span> <span class="n">shmid</span><span class="p">;</span>                   <span class="c1">//共享内存标识符</span>
    <span class="c1">//创建共享内存</span>

    <span class="n">shmid</span> <span class="o">=</span> <span class="n">shmget</span><span class="p">((</span><span class="n">key_t</span><span class="p">)</span><span class="n">MEM_KEY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shared_use_st</span><span class="p">),</span> <span class="mo">0666</span><span class="o">|</span><span class="n">IPC_CREAT</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">shmid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"shmget failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//将共享内存连接到当前进程的地址空间</span>
    <span class="n">shm</span> <span class="o">=</span> <span class="n">shmat</span><span class="p">(</span><span class="n">shmid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">shm</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"shmat failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Memory attached at %X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">shm</span><span class="p">);</span>
    <span class="c1">//设置共享内存</span>
    <span class="n">shared</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">shared_use_st</span><span class="o">*</span><span class="p">)</span><span class="n">shm</span><span class="p">;</span>
    <span class="n">shared</span><span class="o">-&gt;</span><span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">running</span><span class="p">)</span><span class="c1">//读取共享内存中的数据</span>
    <span class="p">{</span>
        <span class="c1">//没有进程向共享内存定数据有数据可读取</span>
        <span class="k">if</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">written</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"You wrote: %s"</span><span class="p">,</span> <span class="n">shared</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">);</span>
            <span class="n">sleep</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">3</span><span class="p">);</span>
            <span class="c1">//读取完数据，设置written使共享内存段可写</span>
            <span class="n">shared</span><span class="o">-&gt;</span><span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="c1">//输入了end，退出循环（程序）</span>
            <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">,</span> <span class="s">"end"</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span><span class="c1">//有其他进程在写数据，不能读取数据</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//把共享内存从当前进程中分离</span>
    <span class="k">if</span><span class="p">(</span><span class="n">shmdt</span><span class="p">(</span><span class="n">shm</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"shmdt failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//删除共享内存</span>
    <span class="k">if</span><span class="p">(</span><span class="n">shmctl</span><span class="p">(</span><span class="n">shmid</span><span class="p">,</span> <span class="n">IPC_RMID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"shmctl(IPC_RMID) failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>shmwrite.c的源代码</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/shm.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"shmdata.h"</span><span class="cp">
</span> 
<span class="cp">#define MEM_KEY      (1234)
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">shm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">shared_use_st</span> <span class="o">*</span><span class="n">shared</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">BUFSIZ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span><span class="c1">//用于保存输入的文本</span>
    <span class="kt">int</span> <span class="n">shmid</span><span class="p">;</span>
    <span class="c1">//创建共享内存</span>
    <span class="n">shmid</span> <span class="o">=</span> <span class="n">shmget</span><span class="p">((</span><span class="n">key_t</span><span class="p">)</span><span class="n">MEM_KEY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">shared_use_st</span><span class="p">),</span> <span class="mo">0666</span><span class="o">|</span><span class="n">IPC_CREAT</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">shmid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"shmget failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//将共享内存连接到当前进程的地址空间</span>
    <span class="n">shm</span> <span class="o">=</span> <span class="n">shmat</span><span class="p">(</span><span class="n">shmid</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">shm</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"shmat failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Memory attached at %X</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">shm</span><span class="p">);</span>
    <span class="c1">//设置共享内存</span>
    <span class="n">shared</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">shared_use_st</span><span class="o">*</span><span class="p">)</span><span class="n">shm</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">running</span><span class="p">)</span><span class="c1">//向共享内存中写数据</span>
    <span class="p">{</span>
        <span class="c1">//数据还没有被读取，则等待数据被读取,不能向共享内存中写入文本</span>
        <span class="k">while</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">written</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Waiting...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="c1">//向共享内存中写入数据</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Enter some text: "</span><span class="p">);</span>
    <span class="n">fgets</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
    <span class="n">strncpy</span><span class="p">(</span><span class="n">shared</span><span class="o">-&gt;</span><span class="n">text</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">TEXT_SZ</span><span class="p">);</span>
    <span class="c1">//写完数据，设置written使共享内存段可读</span>
    <span class="n">shared</span><span class="o">-&gt;</span><span class="n">written</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">//输入了end，退出循环（程序）</span>
    <span class="k">if</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"end"</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//把共享内存从当前进程中分离</span>
    <span class="k">if</span><span class="p">(</span><span class="n">shmdt</span><span class="p">(</span><span class="n">shm</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"shmdt failed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>代码分析：</strong>
(1)程序shmread创建共享内存，然后将它连接到自己的地址空间。在共享内存的开始处使用了一个结构struct_use_st。该结构中有个标志written，当共享内存中有其他进程向它写入数据时，共享内存中的written被设置为0，程序等待。当它不为0时，表示没有进程对共享内存写入数据，程序就从共享内存中读取数据并输出，然后重置设置共享内存中的written为0，即让其可被shmwrite进程写入数据。
(2)程序shmwrite取得共享内存并连接到自己的地址空间中。检查共享内存中的written，是否为0，若不是，表示共享内存中的数据还没有被完，则等待其他进程读取完成，并提示用户等待。若共享内存的written为0，表示没有其他进程对共享内存进行读取，则提示用户输入文本，并再次设置共享内存中的written为1，表示写完成，其他进程可对共享内存进行读操作。</p>

<p><strong>关于前面的例子的安全性讨论</strong>
这个程序是不安全的，当有多个程序同时向共享内存中读写数据时，问题就会出现。可能你会认为，可以改变一下written的使用方式，例如，只有当written为0时进程才可以向共享内存写入数据，而当一个进程只有在written不为0时才能对其进行读取，同时把written进行加1操作，读取完后进行减1操作。这就有点像文件锁中的读写锁的功能。咋看之下，它似乎能行得通。但是这都不是原子操作，所以这种做法是行不能的。试想当written为0时，如果有两个进程同时访问共享内存，它们就会发现written为0，于是两个进程都对其进行写操作，显然不行。当written为1时，有两个进程同时对共享内存进行读操作时也是如些，当这两个进程都读取完是，written就变成了-1.
要想让程序安全地执行，就要有一种进程同步的进制，保证在进入临界区的操作是原子操作。例如，可以使用前面所讲的信号量来进行进程的同步。因为信号量的操作都是原子性的。</p>

<p><strong>使用共享内存的优缺点</strong>
(1)优点：我们可以看到使用共享内存进行进程间的通信真的是非常方便，而且函数的接口也简单，数据的共享还使进程间的数据不用传送，而是直接访问内存，也加快了程序的效率。同时，它也不像匿名管道那样要求通信的进程有一定的父子关系。
(2)缺点：共享内存没有提供同步的机制，这使得我们在使用共享内存进行进程间通信时，往往要借助其他的手段来进行进程间的同步工作。</p>

<p>###四 更好的例子</p>

<p>1、server.c</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*server.c:向共享内存中写入People*/</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/ipc.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/sem.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"credis.h"</span><span class="cp">
</span><span class="kt">int</span> <span class="n">semid</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">shmid</span><span class="p">;</span>
<span class="cm">/*信号量的P操作*/</span>
<span class="kt">void</span> <span class="nf">p</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">sembuf</span> <span class="n">sem_p</span><span class="p">;</span>
    <span class="n">sem_p</span><span class="p">.</span><span class="n">sem_num</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="cm">/*设置哪个信号量*/</span>
    <span class="n">sem_p</span><span class="p">.</span><span class="n">sem_op</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span><span class="cm">/*定义操作*/</span>   
    <span class="k">if</span><span class="p">(</span><span class="n">semop</span><span class="p">(</span><span class="n">semid</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sem_p</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"p operation is fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>  
    <span class="cm">/*semop函数自动执行信号量集合上的操作数组。 
　　 int semop(int semid, struct sembuf semoparray[], size_t nops); 
　　 semoparray是一个指针，它指向一个信号量操作数组。nops规定该数组中操作的数量。*/</span> 
<span class="p">}</span>
<span class="cm">/*信号量的V操作*/</span>
<span class="kt">void</span> <span class="nf">v</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">sembuf</span> <span class="n">sem_v</span><span class="p">;</span>
    <span class="n">sem_v</span><span class="p">.</span><span class="n">sem_num</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">sem_v</span><span class="p">.</span><span class="n">sem_op</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">semop</span><span class="p">(</span><span class="n">semid</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sem_v</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"v operation is fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">People</span><span class="p">{</span>
        <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">age</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">key_t</span> <span class="n">semkey</span><span class="p">;</span>
    <span class="n">key_t</span> <span class="n">shmkey</span><span class="p">;</span>
    <span class="n">semkey</span><span class="o">=</span><span class="n">ftok</span><span class="p">(</span><span class="s">"../test/VenusDB.cbp"</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>       <span class="c1">//用来产生唯一的标志符，便于区分信号量及共享内存</span>
    <span class="n">shmkey</span><span class="o">=</span><span class="n">ftok</span><span class="p">(</span><span class="s">"../test/main.c"</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="cm">/*创建信号量的XSI IPC*/</span>
    <span class="n">semid</span><span class="o">=</span><span class="n">semget</span><span class="p">(</span><span class="n">semkey</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mo">0666</span><span class="o">|</span><span class="n">IPC_CREAT</span><span class="p">);</span><span class="c1">//参数nsems,此时为中间值1，指定信号灯集包含信号灯的数目</span>
    <span class="c1">//0666|IPC_CREAT用来表示对信号灯的读写权限</span>
    <span class="cm">/*
    从左向右:
    第一位:0表示这是一个8进制数
    第二位:当前用户的经权限:6=110(二进制),每一位分别对就 可读,可写,可执行,6说明当前用户可读可写不可执行
    第三位:group组用户,6的意义同上
    第四位:其它用户,每一位的意义同上,0表示不可读不可写也不可执行
    */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">semid</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"creat sem is fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="c1">//创建共享内存</span>
    <span class="n">shmid</span><span class="o">=</span><span class="n">shmget</span><span class="p">(</span><span class="n">shmkey</span><span class="p">,</span><span class="mi">1024</span><span class="p">,</span><span class="mo">0666</span><span class="o">|</span><span class="n">IPC_CREAT</span><span class="p">);</span><span class="c1">//对共享内存</span>
    <span class="k">if</span><span class="p">(</span><span class="n">shmid</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"creat shm is fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="cm">/*设置信号量的初始值，就是资源个数*/</span>
    <span class="k">union</span> <span class="n">semun</span><span class="p">{</span>
        <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">semid_ds</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>
    <span class="p">}</span><span class="n">sem_u</span><span class="p">;</span>
    <span class="n">sem_u</span><span class="p">.</span><span class="n">val</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>    <span class="cm">/*设置变量值*/</span>
    <span class="n">semctl</span><span class="p">(</span><span class="n">semid</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">SETVAL</span><span class="p">,</span><span class="n">sem_u</span><span class="p">);</span>   <span class="c1">//初始化信号量，设置第0个信号量，p()操作为非阻塞的</span>
    <span class="cm">/*将共享内存映射到当前进程的地址中，之后直接对进程中的地址addr操作就是对共享内存操作*/</span>
    <span class="k">struct</span> <span class="n">People</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
    <span class="n">addr</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">People</span><span class="o">*</span><span class="p">)</span><span class="n">shmat</span><span class="p">(</span><span class="n">shmid</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>  <span class="c1">//将共享内存映射到调用此函数的内存段</span>
    <span class="k">if</span><span class="p">(</span><span class="n">addr</span><span class="o">==</span><span class="p">(</span><span class="k">struct</span> <span class="n">People</span><span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"shm shmat is fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="cm">/*向共享内存写入数据*/</span>
    <span class="n">p</span><span class="p">();</span>
    <span class="n">strcpy</span><span class="p">((</span><span class="o">*</span><span class="n">addr</span><span class="p">).</span><span class="n">name</span><span class="p">,</span><span class="s">"xiaoming"</span><span class="p">);</span>
<span class="cm">/*注意：①此处只能给指针指向的地址直接赋值，不能在定义一个  struct People people_1;addr=&amp;people_1;因为addr在addr=(struct People*)shmat(shmid,0,0);时,已经由系统自动分配了一个地址，这个地址与共享内存相关联，所以不能改变这个指针的指向，否则他将不指向共享内存，无法完成通信了。
注意：②给字符数组赋值的方法。刚才太虎了。。*/</span>
    <span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">).</span><span class="n">age</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span>
    <span class="n">v</span><span class="p">();</span>
    <span class="cm">/*将共享内存与当前进程断开*/</span>
    <span class="k">if</span><span class="p">(</span><span class="n">shmdt</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"shmdt is fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>  
<span class="p">}</span>
</code></pre></div></div>

<p>2、clinet.c</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*client.c:从共享内存中读出People*/</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/ipc.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/sem.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="n">semid</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">shmid</span><span class="p">;</span>
<span class="cm">/*信号量的P操作*/</span>
<span class="kt">void</span> <span class="nf">p</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">sembuf</span> <span class="n">sem_p</span><span class="p">;</span>
    <span class="n">sem_p</span><span class="p">.</span><span class="n">sem_num</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">sem_p</span><span class="p">.</span><span class="n">sem_op</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">semop</span><span class="p">(</span><span class="n">semid</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sem_p</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"p operation is fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>  
<span class="p">}</span>
<span class="cm">/*信号量的V操作*/</span>
<span class="kt">void</span> <span class="nf">v</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">sembuf</span> <span class="n">sem_v</span><span class="p">;</span>
    <span class="n">sem_v</span><span class="p">.</span><span class="n">sem_num</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">sem_v</span><span class="p">.</span><span class="n">sem_op</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">semop</span><span class="p">(</span><span class="n">semid</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sem_v</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"v operation is fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">key_t</span> <span class="n">semkey</span><span class="p">;</span>
    <span class="n">key_t</span> <span class="n">shmkey</span><span class="p">;</span>
    <span class="n">semkey</span><span class="o">=</span><span class="n">ftok</span><span class="p">(</span><span class="s">"../test/client/VenusDB.cbp"</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">shmkey</span><span class="o">=</span><span class="n">ftok</span><span class="p">(</span><span class="s">"../test/client/main.c"</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">People</span><span class="p">{</span>
        <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">age</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="cm">/*读取共享内存和信号量的IPC*/</span> 
    <span class="n">semid</span><span class="o">=</span><span class="n">semget</span><span class="p">(</span><span class="n">semkey</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mo">0666</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">semid</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"creat sem is fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">shmid</span><span class="o">=</span><span class="n">shmget</span><span class="p">(</span><span class="n">shmkey</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mo">0666</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">shmid</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"creat shm is fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="cm">/*将共享内存映射到当前进程的地址中，之后直接对进程中的地址addr操作就是对共享内存操作*/</span>
    <span class="k">struct</span> <span class="n">People</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
    <span class="n">addr</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">People</span><span class="o">*</span><span class="p">)</span><span class="n">shmat</span><span class="p">(</span><span class="n">shmid</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">addr</span><span class="o">==</span><span class="p">(</span><span class="k">struct</span> <span class="n">People</span><span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"shm shmat is fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="cm">/*从共享内存读出数据*/</span>
    <span class="n">p</span><span class="p">();</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"name:%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"age:%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">);</span>
    <span class="n">v</span><span class="p">();</span>
    <span class="cm">/*将共享内存与当前进程断开*/</span>
    <span class="k">if</span><span class="p">(</span><span class="n">shmdt</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"shmdt is fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
 
    <span class="cm">/*IPC必须显示删除。否则会一直留存在系统中*/</span>
    <span class="k">if</span><span class="p">(</span><span class="n">semctl</span><span class="p">(</span><span class="n">semid</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">IPC_RMID</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"semctl delete error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">shmctl</span><span class="p">(</span><span class="n">shmid</span><span class="p">,</span><span class="n">IPC_RMID</span><span class="p">,</span><span class="nb">NULL</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"shmctl delete error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="五-父子进程共享内存的例子">五 父子进程共享内存的例子</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="c1">  </span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="c1">  </span><span class="cp">
#include</span> <span class="cpf">&lt;sys/ipc.h&gt;</span><span class="c1">  </span><span class="cp">
#include</span> <span class="cpf">&lt;sys/sem.h&gt;</span><span class="c1">  </span><span class="cp">
</span>  
<span class="cp">#define SHM_KEY 0x33  
#define SEM_KEY 0x44  
</span>  
<span class="k">union</span> <span class="n">semun</span> <span class="p">{</span>  
    <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>  
    <span class="k">struct</span> <span class="n">semid_ds</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>  
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">array</span><span class="p">;</span>  
<span class="p">};</span>  
  
<span class="kt">int</span> <span class="nf">P</span><span class="p">(</span><span class="kt">int</span> <span class="n">semid</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">struct</span> <span class="n">sembuf</span> <span class="n">sb</span><span class="p">;</span>  
    <span class="n">sb</span><span class="p">.</span><span class="n">sem_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
    <span class="n">sb</span><span class="p">.</span><span class="n">sem_op</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  
    <span class="n">sb</span><span class="p">.</span><span class="n">sem_flg</span> <span class="o">=</span> <span class="n">SEM_UNDO</span><span class="p">;</span>  
      
    <span class="k">if</span><span class="p">(</span><span class="n">semop</span><span class="p">(</span><span class="n">semid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  
        <span class="n">perror</span><span class="p">(</span><span class="s">"semop"</span><span class="p">);</span>  
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  
    <span class="p">}</span>  
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  
  
<span class="kt">int</span> <span class="nf">V</span><span class="p">(</span><span class="kt">int</span> <span class="n">semid</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="k">struct</span> <span class="n">sembuf</span> <span class="n">sb</span><span class="p">;</span>  
    <span class="n">sb</span><span class="p">.</span><span class="n">sem_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
    <span class="n">sb</span><span class="p">.</span><span class="n">sem_op</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  
    <span class="n">sb</span><span class="p">.</span><span class="n">sem_flg</span> <span class="o">=</span> <span class="n">SEM_UNDO</span><span class="p">;</span>  
      
    <span class="k">if</span><span class="p">(</span><span class="n">semop</span><span class="p">(</span><span class="n">semid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  
        <span class="n">perror</span><span class="p">(</span><span class="s">"semop"</span><span class="p">);</span>  
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  
    <span class="p">}</span>  
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  
  
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>  
<span class="p">{</span>  
    <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>  
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">shmid</span><span class="p">,</span> <span class="n">semid</span><span class="p">;</span>  
    <span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>  
    <span class="k">union</span> <span class="n">semun</span> <span class="n">semopts</span><span class="p">;</span>  
  
    <span class="cm">/* 创建一块共享内存, 存一个int变量 */</span>  
    <span class="k">if</span> <span class="p">((</span><span class="n">shmid</span> <span class="o">=</span> <span class="n">shmget</span><span class="p">(</span><span class="n">SHM_KEY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="n">IPC_CREAT</span> <span class="o">|</span> <span class="mo">0600</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  
        <span class="n">perror</span><span class="p">(</span><span class="s">"msgget"</span><span class="p">);</span>  
    <span class="p">}</span>  
    <span class="cm">/* 将共享内存映射到进程, fork后子进程可以继承映射 */</span>  
    <span class="k">if</span> <span class="p">((</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">shmat</span><span class="p">(</span><span class="n">shmid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  
        <span class="n">perror</span><span class="p">(</span><span class="s">"shmat"</span><span class="p">);</span>  
    <span class="p">}</span>  
    <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
    <span class="cm">/* 创建一个信号量用来同步共享内存的操作 */</span>  
    <span class="k">if</span> <span class="p">((</span><span class="n">semid</span> <span class="o">=</span> <span class="n">semget</span><span class="p">(</span><span class="n">SEM_KEY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IPC_CREAT</span> <span class="o">|</span> <span class="mo">0600</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  
        <span class="n">perror</span><span class="p">(</span><span class="s">"semget"</span><span class="p">);</span>  
    <span class="p">}</span>  
    <span class="cm">/* 初始化信号量 */</span>  
    <span class="n">semopts</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  
    <span class="k">if</span> <span class="p">(</span><span class="n">semctl</span><span class="p">(</span><span class="n">semid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SETVAL</span><span class="p">,</span> <span class="n">semopts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  
        <span class="n">perror</span><span class="p">(</span><span class="s">"semctl"</span><span class="p">);</span>  
    <span class="p">}</span>  
    <span class="k">if</span> <span class="p">((</span><span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  
        <span class="n">perror</span><span class="p">(</span><span class="s">"fork"</span><span class="p">);</span>  
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>      <span class="cm">/* Child */</span>  
        <span class="cm">/* 子进程对共享内存加1 */</span>  
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>  
            <span class="n">P</span><span class="p">(</span><span class="n">semid</span><span class="p">);</span>  
            <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>  
            <span class="n">V</span><span class="p">(</span><span class="n">semid</span><span class="p">);</span>  
            <span class="n">printf</span><span class="p">(</span><span class="s">"child: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>  
        <span class="p">}</span>  
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                    <span class="cm">/* Parent */</span>  
        <span class="cm">/* 父进程对共享内存减1 */</span>  
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>  
            <span class="n">P</span><span class="p">(</span><span class="n">semid</span><span class="p">);</span>  
            <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="o">--</span><span class="p">;</span>  
            <span class="n">V</span><span class="p">(</span><span class="n">semid</span><span class="p">);</span>  
            <span class="n">printf</span><span class="p">(</span><span class="s">"parent: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>  
        <span class="p">}</span>  
        <span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>  
        <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="cm">/* 如果同步成功, 共享内存的值为0 */</span>  
        <span class="n">printf</span><span class="p">(</span><span class="s">"finally: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>  
    <span class="p">}</span>  
  
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  
</code></pre></div></div>


  		
	  </article>
    </div>

</div>

<span>
	<a  href="/linux-process-msg" class="pageNav"  >上一篇</a>
	&nbsp;&nbsp;&nbsp;
	<a  href="/linux-process-socket" class="pageNav"  >下一篇</a>
</span>


	<div class="article-author">
    <div class="name">
        <h4><b>carlos</b> </h4>
        Just for fun!
    </div>
    <div class="avatar">
        <img width="50" height="50" src="/images/header.png" alt=" Avatar"/>
    </div>
</div>


	
	    <!--
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = '';
	(function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
	



<!--
<div class="cnzz"><script src="http://s4.cnzz.com/z_stat.php?id=1255123325&web_id=1255123325" language="JavaScript"></script> </div>
 -->

        </div>
      </div>
    </div>

    </body>
</html>
