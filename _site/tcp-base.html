<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>TCP 协议笔记</title>

    <meta name="viewport" content="width=device-width">
    <meta name="description" content="">

    
    

    <link rel="canonical" href="http://blog.xyecho.com/tcp-base">
    <link rel="icon" type="image/png" href="/images/logo.png">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/monster.css">

    

</head>


    <body>
    
    <div class="wrapper">

      <header class="header">

  <div class="site-title">
    
    <h4 class="entry-title"><a href="/tcp-base">TCP 协议笔记</a></h4>
    
  </div>

<div class="links">
    
    <a href="/" class="page-link">Blog</a>
    
    
    
    
      <a class="page-link"
        href="/about/">About</a>
    
    
    
      <a class="page-link"
        href="/categories">Categories</a>
    
    
    
    
    
    
    
      <a class="page-link"
        href="/links/">Links</a>
    
    
    
    
    
      <a class="page-link"
        href="/tags">Tags</a>
    
    
    <a href="/feed.xml" target="_blank" class="page-link">RSS</a>
</div>
</header>

      
      <div class="navi">
    
    <a href="/" class="page-link">Blog</a>
    
    
    
    
      <a class="page-link"
        href="/about/">About</a>
    
    
    
      <a class="page-link"
        href="/categories">Categories</a>
    
    
    
    
    
    
    
      <a class="page-link"
        href="/links/">Links</a>
    
    
    
    
    
      <a class="page-link"
        href="/tags">Tags</a>
    
    
    <a href="/feed.xml" target="_blank" class="page-link">RSS</a>
</div>


      <div class="content">
        <div class="articles">
            <div class="article-meta">
    2014-10-15
     • Category: 
        
        <a href="/categories#tcp-ref" >tcp</a>
        
    
     • Tag: 
        
            <a href="/tags#network-ref" >network</a>
        
            <a href="/tags#tcp-ref" >tcp</a>
        
    
</div>


<div class="entry post">

	<div class="entry-content">
	  <article class="entry-body">
	  	
	  		<p>从四个方面来理解TCP协议：</p>

<p>1、 TCP 头部信息</p>

<p>2、 TCP 状态转移过程</p>

<p>3、 TCP 数据流</p>

<p>4、 TCP 数据流的控制</p>

<h1 id="一tcp-头部信息">一、TCP 头部信息</h1>

<p><img src="/assets/network/tcp-base-1.png" alt="" /></p>

<p>说明：</p>

<p>1、16 位端口号：告知这个报文来自那个源端口和给上层协议或者应用那个目的端口。（注意IP是在IP协议层里的）</p>

<p>2、32 位序号：一次 TCP 通信（从 TCP 连接到断开）过程中某一个传输方向上的字节流的每个字节编号。</p>

<p>3、32 位确认号：用作对另一方发送来的TCP报文的响应。</p>

<p>4、4 位头部长度：标识该TCP头部多少个 32 bit（4字节）因为 4 位最大能表示 15，所以TCP头最长 60 字节。（15*4=60）</p>

<p><strong>5、6 位标志们包含好下</strong>：</p>

<p>（1）URG 表示紧急指针是否有效</p>

<p>（2）ACK 表示确认号是否有效</p>

<p>（3）PSH 提示接收端应用程序应该即人TCP接收缓冲区中读走数据，为接收后续数据腾出空间。</p>

<p>（4）RST 表示要求对方重新连接。</p>

<p>（5）SYN 表示请求建立一个连接。</p>

<p>（6）FIN 表示通知对方本端村关闭连接。</p>

<p>6、16 位窗口大小 : 是TCP流量控制的一个手段。它告诉对方本端的TCP接收缓冲区还能容纳多少字节的数据，这样对方就可以控制发送数据的速度。</p>

<p>7、16 位校验和：同发送方填充。用CRC对数据作检验，这个校验不肥包括TCP头部，也包括数据部分，TCP可靠传输的一个生要保障。</p>

<p>8、16 位紧急指针：是一个正的偏移量，它和序号字段的值相加表示最后一个紧急数据的下一字节的序号。</p>

<p>9、TCP头部选项 ：这部分最后含有40字节。</p>

<p>kind=0：选项表结束选项</p>

<p>kind=1：空操作（nop）选项</p>

<p>kind=2：最大报文段长度选项，TCP模块通常将MSS设置为（MTU-40）字节（减掉的这40字节包括20字节 的TCP头部和20字节的IP头部）对以太网而言，MSS值是1460（1500-40）</p>

<p>kind=3：窗口扩大因子选项 。窗口扩大因了选项只能出现在同步报文段中。</p>

<p>kind=4：选择性确认 。使TCP模块只能重新发送丢失的TCP报文段、不用发送所有未被确认的 TCP报文段。</p>

<p>kind=5：SACK实际工作的选项</p>

<p>kind=8：时间戳选项 提供较为准确的计算通信双方之间的回路时间的方法。</p>

<h1 id="二tcp-状态转移过程">二、TCP 状态转移过程</h1>

<p><strong>半关闭状态</strong></p>

<p>TCP 连接是全双工的，所以它允许两个方向的数据传输被独立关闭，通信的一端可艰送结束报文给对方，告诉它本端已经完成了数据的发送。但允许继续接收来息对方的数据 ，直到对方也发送结束报文段以关闭连接。TCP连接的这种状态称为半关闭状态。
服务器和客户端应用程序 判断对方是否已经关闭连接的方法是：<code class="language-plaintext highlighter-rouge">read</code> 系统调用返回 0（收到结束报文段）。</p>

<p>socket 网络编程接口通过 shutdown 函数提供了对阗关闭的支持。</p>

<p>连接超时 ~~</p>

<p><strong>三次握手 四次挥手:</strong></p>

<p><img src="/assets/network/tcp-base-2.png" alt="" /></p>

<p><strong>TIME_WAIT 状态</strong></p>

<p>从图可以看，客户端连接在收到服务器的结束报文段之后，并没有直接进入 CLOSED 状态，而是转移到 TIME_WAIT 状态。在这个状态，客户端连接要等待一段时间为2MSL的时间。才能完全关闭。</p>

<p>MSL 是TCP报文段在刚和　的最大生存时间。</p>

<p><strong>TIME_WAIT 状态存在的原因有两点:</strong></p>

<p>1）可靠地终止 TCP 连接。</p>

<p>2）保证让发来的 TCP 报文段有足够的时间被识别并丢弃。</p>

<p>第一个原因：用于确认服务器结束报文段６和报文段７丢失。那么服务器重发结束报文段。因此客户端需要停留在某个以处理重复收到的结束报文段（即向服务器发送确认报文段）</p>

<p>第二个原因：在 linux 系统上，一个TCP端口不能被同时打开多次（两次及以上）。当一个TCP连接处于 TIME_WAIT 状态时。我们将无法立即使用该连接占用着的端口来建立一个连接。如果不存在TIME_WAIT，则应用程序程序能够立即建立一个和刚关闭的连接相似的连接（同IP地址和端口号）这个新连接被称了连接的化身。它可能会接收到属于原来的连接的应用程序数据。这是不应该发的事。</p>

<p>另外，因为 TCP 报文段的最大生存时间是MSL,所以坚持 2MSL 时间的 TIME_WAIT  状态能够确保网络上两具传输方向上接收到的、迟到的 TCP 报文都已经消失。因此一个新连接可能在 2MSL 时间后安全地建立。</p>

<p>复位报文段</p>

<p>在某些特殊条件下，TCP 连接的一端会向另一端发送携带 RST 标志的报文段，即复位报文段。</p>

<p>异常终止连接</p>

<p>TCP 提供了异常终止一个连接的方法，即给对方发送一个复位报文段。一旦发送了复位报文段，发送端所有排除等待的数据都将被丢弃。</p>

<p>处理半打开连接</p>

<p>服务器（或客户端）关闭或者异常终止了连接，而对方没有接收到结束报文段（比如发生了网络故障），此时，客户端（或服务端）还维持着原来的连接，而服务器（或客户端）即使重启，也已经没有该连接的任何信息了。我们将这种状态称为打开状态，处于这种连接称为半找连接。如果客户端（或服务器）往处于阗打开连接写入数据，则对方方将回应一个复位报文段。</p>

<p>TCP 交互数据流</p>

<p>TCP 报文段所携带的应用程序数据按照长度分为两种：交互数据和成块数据。交互灵气公包含很少的字节。使用交互数据的应用程序（或协议）对实时性求高。如 telnet、ssh。成块数据的长度则通常用TCP报文段允许的最大数据长度。使用成块数据的应用程序 （协议）对传输效率要求高，如 ftp。</p>

<p>带外数据</p>

<p>带外数据用于迅速通知对方本端发生的重要事件。因此，带外数据比普通数据（也称为带内数据）表更高的优先级。它应该总是立即被发送，而不论发送缓冲区中是否有排队等待发送的普通数据。
UDP 没有实现带外数据传输，TCP 也没有真正的带外数据。不过TCP利用其头部中的紧急指针标志和紧急指针两个字段，给应用程序提供了一种紧急方式 。</p>

<p>TCP 超时重传</p>

<p>TCP 服务必须能够重传超时间内未收到确认的 TCP 报文段。为此， TCP报文段都维护一个重传定时器，该定时器在TCP报文段第一次被发送时启动。如果超时时间内未收到接收方的应答，TCP模块将重传TCP报文段并重置定时器。至于下次重传的超时时间如何选择，以及最多执行多少次重传，就是TCP的重传策略。一共会执行5次重传。次数可以系统相关配置更改。/proc/sys/net/ipv4/tcp_retries1和/proc/sys/net/ipv4/tcp_retries2 前者指定 在底IP接管之前TCP最少执行的重传次数，默认值是３，后者指定 连接放弃前TCP最多可以执行的重传次数，默认值是15。</p>

<p>拥塞控制</p>

<p>TCP 拥塞控制的四个部分：慢启动、拥塞避免、快速重传、快速恢复、快速恢复。</p>

<p>TCP 为什么叫数据流：应用程序对数据的发送和接收是没有边界限制的。</p>

<p>TCP 为什么是可靠的：TCP协议采用发送应答机制，即发送端发送的每个TCP报文段都必须得到接收方的应答，其次，采用超时重传机制。</p>

<p>UDP 虽然说是不可靠服务，但是可以在上层协议来处理数据确认和超时重传。</p>


  		
	  </article>
    </div>

</div>

<span>
	<a  href="/select" class="pageNav"  >上一篇</a>
	&nbsp;&nbsp;&nbsp;
	<a  href="/linux-gdb" class="pageNav"  >下一篇</a>
</span>


	<div class="article-author">
    <div class="name">
        <h4><b>carlos</b> </h4>
        Just for fun!
    </div>
    <div class="avatar">
        <img width="50" height="50" src="/images/header.png" alt=" Avatar"/>
    </div>
</div>


	
	    <!--
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = '';
	(function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
	



<!--
<div class="cnzz"><script src="http://s4.cnzz.com/z_stat.php?id=1255123325&web_id=1255123325" language="JavaScript"></script> </div>
 -->

        </div>
      </div>
    </div>

    </body>
</html>
