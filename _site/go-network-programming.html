<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>golang 笔记 网络编程</title>

    <meta name="viewport" content="width=device-width">
    <meta name="description" content="">

    
    

    <link rel="canonical" href="http://localhost:4000/go-network-programming">
    <link rel="icon" type="image/png" href="/images/logo.png">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/monster.css">

    

</head>


    <body>
    
    <div class="wrapper">

      <header class="header">

  <div class="site-title">
    
    <h4 class="entry-title"><a href="/go-network-programming">golang 笔记 网络编程</a></h4>
    
  </div>

<div class="links">
    
    <a href="/" class="page-link">Blog</a>
    
    
    
    
      <a class="page-link"
        href="/about/">About</a>
    
    
    
      <a class="page-link"
        href="/categories">Categories</a>
    
    
    
    
    
    
    
      <a class="page-link"
        href="/links/">Links</a>
    
    
    
    
    
      <a class="page-link"
        href="/tags">Tags</a>
    
    
    <a href="/feed.xml" target="_blank" class="page-link">RSS</a>
</div>
</header>

      
      <div class="navi">
    
    <a href="/" class="page-link">Blog</a>
    
    
    
    
      <a class="page-link"
        href="/about/">About</a>
    
    
    
      <a class="page-link"
        href="/categories">Categories</a>
    
    
    
    
    
    
    
      <a class="page-link"
        href="/links/">Links</a>
    
    
    
    
    
      <a class="page-link"
        href="/tags">Tags</a>
    
    
    <a href="/feed.xml" target="_blank" class="page-link">RSS</a>
</div>


      <div class="content">
        <div class="articles">
            <div class="article-meta">
    2018-03-04
     • Category: 
        
        <a href="/categories#go-ref" >go</a>
        
    
     • Tag: 
        
            <a href="/tags#go-ref" >go</a>
        
    
</div>


<div class="entry post">

	<div class="entry-content">
	  <article class="entry-body">
	  	
	  		<p>Go 语言标准库里提供的 net 包，支持基于 IP 层、TCP/UDP 层及更高层面(如 HTTP、FTP、SMTP )的网络操作，其中用于 IP 层的称为 Raw Socket。</p>

<h1 id="一socket-编程">一、socket 编程</h1>

<p>Go 语言标准库对此过程进行了抽象和封装。无论我们期望使用什么协议建立什么形式的连接，都只需要调用<code class="language-plaintext highlighter-rouge">net.Dial()</code>即可。</p>

<h2 id="11-dial函数">1.1 Dial()函数</h2>

<p><code class="language-plaintext highlighter-rouge">Dial()</code> 函数的原型如下:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">Dial</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">addr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">Conn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></div></div>

<p>其中 net 参数是网络协议的名字，addr 参数是 IP 地址或域名，而端口号以“:”的形式跟随在地址 或域名的后面，端口号可选。如果连接成功，返回连接对象，否则返回 error。</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// TCP链接:</span>
<span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">net</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span><span class="s">"tcp"</span><span class="p">,</span> <span class="s">"192.168.0.10:2100"</span><span class="p">)</span>

<span class="c">// UDP链接:</span>
<span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">net</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span><span class="s">"udp"</span><span class="p">,</span> <span class="s">"192.168.0.12:975"</span><span class="p">)</span>

<span class="c">// ICMP 链接(使用协议名称):</span>
<span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">net</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span><span class="s">"ip4:icmp"</span><span class="p">,</span> <span class="s">"www.baidu.com"</span><span class="p">)</span>

<span class="c">// ICMP链接(使用协议编号):</span>
<span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">net</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span><span class="s">"ip4:1"</span><span class="p">,</span> <span class="s">"10.0.0.3"</span><span class="p">)</span>
</code></pre></div></div>

<p>目前，<code class="language-plaintext highlighter-rouge">Dial()</code> 函数支持如下几种网络协议: “tcp”、”tcp4”(仅限IPv4)、”tcp6”(仅限 IPv6)、”udp”、”udp4”(仅限IPv4)、”udp6”(仅限IPv6)、”ip”、”ip4”(仅限IPv4)和”ip6”(仅限IPv6)。</p>

<p>在成功建立连接后，我们就可以进行数据的发送和接收。发送数据时，使用 conn 的 <code class="language-plaintext highlighter-rouge">Write()</code> 成员方法，接收数据时使用 Read()方法。</p>

<h2 id="12-tcp示例程序">1.2 TCP示例程序</h2>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>
<span class="k">import</span> <span class="p">(</span><span class="s">"net"</span>
        <span class="s">"os"</span>
        <span class="s">"bytes"</span>
        <span class="s">"fmt"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">)</span> <span class="o">!=</span> <span class="m">2</span> <span class="p">{</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stderr</span><span class="p">,</span> <span class="s">"Usage: %s host:port"</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">0</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> 
    <span class="p">}</span>

    <span class="n">service</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">net</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span><span class="s">"tcp"</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span>
    <span class="n">checkError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"HEAD / HTTP/1.0</span><span class="se">\r\n\r\n</span><span class="s">"</span><span class="p">))</span> 
    <span class="n">checkError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

    <span class="n">result</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">readFully</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">checkError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> 
    <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">checkError</span><span class="p">(</span><span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stderr</span><span class="p">,</span> <span class="s">"Fatal error: %s"</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span>
      <span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
    <span class="p">}</span> 
<span class="p">}</span>

<span class="k">func</span> <span class="n">readFully</span><span class="p">(</span><span class="n">conn</span> <span class="n">net</span><span class="o">.</span><span class="n">Conn</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">defer</span> <span class="n">conn</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">:=</span> <span class="n">bytes</span><span class="o">.</span><span class="n">NewBuffer</span><span class="p">(</span><span class="no">nil</span><span class="p">)</span> 
    <span class="k">var</span> <span class="n">buf</span> <span class="p">[</span><span class="m">512</span><span class="p">]</span><span class="kt">byte</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">conn</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="m">0</span><span class="o">:</span><span class="p">])</span> 
        <span class="n">result</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="m">0</span><span class="o">:</span><span class="n">n</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="n">io</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span> 
                <span class="k">break</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span> 
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">Bytes</span><span class="p">(),</span> <span class="no">nil</span> 
<span class="p">}</span>
</code></pre></div></div>
<h2 id="13-更丰富的网络通信">1.3 更丰富的网络通信</h2>

<p><code class="language-plaintext highlighter-rouge">Dial()</code> 函数是对 <code class="language-plaintext highlighter-rouge">DialTCP()</code>、<code class="language-plaintext highlighter-rouge">DialUDP()</code>、<code class="language-plaintext highlighter-rouge">DialIP()</code> 和 <code class="language-plaintext highlighter-rouge">DialUnix()</code> 的封装。我们也可以直接调用这些函数，它们的功能是一致的。这些函数的原型如下:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">DialTCP</span><span class="p">(</span><span class="n">net</span> <span class="kt">string</span><span class="p">,</span> <span class="n">laddr</span><span class="p">,</span> <span class="n">raddr</span> <span class="o">*</span><span class="n">TCPAddr</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">TCPConn</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span> 
<span class="k">func</span> <span class="n">DialUDP</span><span class="p">(</span><span class="n">net</span> <span class="kt">string</span><span class="p">,</span> <span class="n">laddr</span><span class="p">,</span> <span class="n">raddr</span> <span class="o">*</span><span class="n">UDPAddr</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">UDPConn</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span> 
<span class="k">func</span> <span class="n">DialIP</span><span class="p">(</span><span class="n">netProto</span> <span class="kt">string</span><span class="p">,</span> <span class="n">laddr</span><span class="p">,</span> <span class="n">raddr</span> <span class="o">*</span><span class="n">IPAddr</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">IPConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="n">DialUnix</span><span class="p">(</span><span class="n">net</span> <span class="kt">string</span><span class="p">,</span> <span class="n">laddr</span><span class="p">,</span> <span class="n">raddr</span> <span class="o">*</span><span class="n">UnixAddr</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">UnixConn</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></div></div>

<p>验证IP地址有效性；</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">net</span><span class="o">.</span><span class="n">ParseIP</span><span class="p">()</span>
</code></pre></div></div>

<p>根据域名查找IP的代码如下:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">ResolveIPAddr</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">addr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">IPAddr</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="n">LookupHost</span><span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">cname</span> <span class="kt">string</span><span class="p">,</span> <span class="n">addrs</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">);</span>
</code></pre></div></div>

<h1 id="二http-编程">二、HTTP 编程</h1>

<p>Go 语言标准库内建提供了net/http包，涵盖了HTTP客户端和服务端的具体实现。使用 <code class="language-plaintext highlighter-rouge">net/http</code> 包，我们可以很方便地编写 HTTP 客户端或服务端的程序。</p>

<h2 id="21-http-客户端">2.1 HTTP 客户端</h2>

<p>Go 内置的 <code class="language-plaintext highlighter-rouge">net/http</code> 包提供了最简洁的 HTTP 客户端实现，我们无需借助第三方网络通信库 (比如 libcurl )就可以直接使用 HTTP 中用得最多的 GET 和 POST 方式请求数据。</p>

<h3 id="基本方法">基本方法</h3>

<p><code class="language-plaintext highlighter-rouge">net/http</code> 包的 Client 类型提供了如下几个方法，让我们可以用最简洁的方式实现 HTTP 请求:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Client</span><span class="p">)</span> <span class="n">Get</span><span class="p">(</span><span class="n">url</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">Response</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Client</span><span class="p">)</span> <span class="n">Post</span><span class="p">(</span><span class="n">url</span> <span class="kt">string</span><span class="p">,</span> <span class="n">bodyType</span> <span class="kt">string</span><span class="p">,</span> <span class="n">body</span> <span class="n">io</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">Response</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Client</span><span class="p">)</span> <span class="n">PostForm</span><span class="p">(</span><span class="n">url</span> <span class="kt">string</span><span class="p">,</span> <span class="n">data</span> <span class="n">url</span><span class="o">.</span><span class="n">Values</span><span class="p">)</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">Response</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span> 
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Client</span><span class="p">)</span> <span class="n">Head</span><span class="p">(</span><span class="n">url</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">Response</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">Client</span><span class="p">)</span> <span class="n">Do</span><span class="p">(</span><span class="n">req</span> <span class="o">*</span><span class="n">Request</span><span class="p">)</span> <span class="p">(</span><span class="n">resp</span> <span class="o">*</span><span class="n">Response</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>http.Get()</strong></p>

<p>要请求一个资源，只需调用 <code class="language-plaintext highlighter-rouge">http.Get()</code> 方法(等价于 <code class="language-plaintext highlighter-rouge">http.DefaultClient.Get()</code> )即可。</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="s">"http://example.com/"</span><span class="p">)</span> 
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="c">// 处理错误 ...</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="k">defer</span> <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="nb">close</span><span class="p">()</span>
<span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>http.Post()</strong></p>

<p>调用<code class="language-plaintext highlighter-rouge">http.Post()</code>方法并依次传递下面的3个参数即可</p>

<ul>
  <li>请求的目标 URL</li>
  <li>将要 POST 数据的资源类型( MIMEType )</li>
  <li>数据的比特流(<code class="language-plaintext highlighter-rouge">[]byte</code> 形式)</li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Post</span><span class="p">(</span><span class="s">"http://example.com/upload"</span><span class="p">,</span> <span class="s">"image/jpeg"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imageDataBuf</span><span class="p">)</span> 
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="c">// 处理错误</span>
    <span class="k">return</span>
<span class="p">}</span>
<span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">StatusCode</span> <span class="o">!=</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusOK</span> <span class="p">{</span> <span class="c">// 处理错误</span>
    <span class="k">return</span>
<span class="p">}</span>
<span class="c">// ...</span>
</code></pre></div></div>

<p><strong>http.PostForm()</strong></p>

<p>实现了标准编码格式为<code class="language-plaintext highlighter-rouge">application/x-www-form-urlencoded</code>的表单提交</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">PostForm</span><span class="p">(</span><span class="s">"http://example.com/posts"</span><span class="p">,</span> 
                            <span class="n">url</span><span class="o">.</span><span class="n">Values</span><span class="p">{</span><span class="s">"title"</span><span class="o">:</span> <span class="p">{</span><span class="s">"article title"</span><span class="p">},</span> <span class="s">"content"</span><span class="o">:</span> <span class="p">{</span><span class="s">"article body"</span><span class="p">}})</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span> <span class="c">// 处理错误</span>
    <span class="k">return</span>
<span class="p">}</span>
<span class="c">// ...</span>
</code></pre></div></div>

<p><strong>http.Head()</strong></p>

<p>HTTP 中的 Head 请求方式表明只请求目标 URL 的头部信息，即 HTTP Header 而不返回 HTTP Body。</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Head</span><span class="p">(</span><span class="s">"http://example.com/"</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>(*http.Client).Do()</strong></p>

<p>在多数情况下，<code class="language-plaintext highlighter-rouge">http.Get()</code> 和 <code class="language-plaintext highlighter-rouge">http.PostForm()</code> 就可以满足需求，但是如果我们发起的 HTTP 请求需要更多的定制信息，我们希望设定一些自定义的 Http Header 字段。</p>

<ul>
  <li>设定自定义的”User-Agent”。</li>
  <li>传递 Cookie</li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">req</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">NewRequest</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span> <span class="s">"http://example.com"</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span> <span class="c">// ...</span>
<span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"User-Agent"</span><span class="p">,</span> <span class="s">"Gobook Custom User-Agent"</span><span class="p">)</span>

<span class="c">// ...</span>
<span class="n">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">http</span><span class="o">.</span><span class="n">Client</span><span class="p">{</span> 
<span class="c">//... </span>
<span class="p">}</span>

<span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="c">// ...</span>
</code></pre></div></div>

<h2 id="22-http-服务端">2.2 HTTP 服务端</h2>

<h3 id="处理-http-请求">处理 HTTP 请求</h3>

<p>使用 <code class="language-plaintext highlighter-rouge">net/http</code> 包提供的 <code class="language-plaintext highlighter-rouge">http.ListenAndServe()</code> 方法，可以在指定的地址进行监听， 开启一个 HTTP，服务端该方法的原型如下:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">ListenAndServe</span><span class="p">(</span><span class="n">addr</span> <span class="kt">string</span><span class="p">,</span> <span class="n">handler</span> <span class="n">Handler</span><span class="p">)</span> <span class="kt">error</span>
</code></pre></div></div>
<p>该方法用于在指定的 TCP 网络地址 addr 进行监听，然后调用服务端处理程序来处理传入的连接请求。该方法有两个参数:</p>

<p>1、 addr 即监听地址;</p>

<p>2、表示服务端处理程序，通常为空，这意味着服务端调用 <code class="language-plaintext highlighter-rouge">http.DefaultServeMux</code> 进行处理，而服务端编写的业务逻 辑处理程序 <code class="language-plaintext highlighter-rouge">http.Handle()</code> 或 <code class="language-plaintext highlighter-rouge">http.HandleFunc()</code> 默认注入 <code class="language-plaintext highlighter-rouge">http.DefaultServeMux</code> 中。</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/foo"</span><span class="p">,</span> <span class="n">fooHandler</span><span class="p">)</span>
<span class="n">http</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/bar"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s">"Hello, %q"</span><span class="p">,</span> <span class="n">html</span><span class="o">.</span><span class="n">EscapeString</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">URL</span><span class="o">.</span><span class="n">Path</span><span class="p">))</span>
                        <span class="p">})</span> 
<span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":8080"</span><span class="p">,</span> <span class="no">nil</span><span class="p">))</span>
</code></pre></div></div>
<p>如果想更多地控制服务端的行为，可以自定义 <code class="language-plaintext highlighter-rouge">http.Server</code></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">http</span><span class="o">.</span><span class="n">Server</span><span class="p">{</span>
    <span class="n">Addr</span><span class="o">:</span>               <span class="s">":8080"</span><span class="p">,</span>
    <span class="n">Handler</span><span class="o">:</span>            <span class="n">myHandler</span><span class="p">,</span>
    <span class="n">ReadTimeout</span><span class="o">:</span>        <span class="m">10</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
    <span class="n">WriteTimeout</span><span class="o">:</span>       <span class="m">10</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
    <span class="n">MaxHeaderBytes</span><span class="o">:</span> <span class="m">1</span> <span class="o">&lt;&lt;</span> <span class="m">20</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">())</span>
</code></pre></div></div>
<h3 id="处理-https-请求">处理 HTTPS 请求</h3>

<p>net/http 包还提供  <code class="language-plaintext highlighter-rouge">http.ListenAndServeTLS()</code> 方法，用于处理 HTTPS 连接请求:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">ListenAndServeTLS</span><span class="p">(</span><span class="n">addr</span> <span class="kt">string</span><span class="p">,</span> <span class="n">certFile</span> <span class="kt">string</span><span class="p">,</span> <span class="n">keyFile</span> <span class="kt">string</span><span class="p">,</span> <span class="n">handler</span> <span class="n">Handler</span><span class="p">)</span> <span class="kt">error</span>
</code></pre></div></div>
<p>certFile 对应 SSL 证书文件存放路径，keyFile 对应证书私钥文件路径。如果证书是由证书颁发机构签署的，certFile 参数指定的路径必须是存放在服务器上的经由 CA 认证过的 SSL 证书。</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">http</span><span class="o">.</span><span class="n">Handle</span><span class="p">(</span><span class="s">"/foo"</span><span class="p">,</span> <span class="n">fooHandler</span><span class="p">)</span>
<span class="n">http</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/bar"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">fmt</span><span class="o">.</span><span class="n">Fprintf</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s">"Hello, %q"</span><span class="p">,</span> <span class="n">html</span><span class="o">.</span><span class="n">EscapeString</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">URL</span><span class="o">.</span><span class="n">Path</span><span class="p">))</span> 
                            <span class="p">})</span>

<span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">ListenAndServeTLS</span><span class="p">(</span><span class="s">":10443"</span><span class="p">,</span> <span class="s">"cert.pem"</span><span class="p">,</span> <span class="s">"key.pem"</span><span class="p">,</span> <span class="no">nil</span><span class="p">))</span>
</code></pre></div></div>

<h1 id="三json-处理">三、Json 处理</h1>

<p>Go 语言内建对 JSON 的 支持。使用 Go 语言内置的 <code class="language-plaintext highlighter-rouge">encoding/json</code> 标准库。</p>

<h2 id="31-编码为json格式">3.1 编码为JSON格式</h2>

<p>使用 <code class="language-plaintext highlighter-rouge">json.Marshal()</code> 函数可以对一组数据进行JSON格式的编码。<code class="language-plaintext highlighter-rouge">json.Marshal()</code> 函数的声明如下:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">Marshal</span><span class="p">(</span><span class="n">v</span> <span class="k">interface</span><span class="p">{})</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Book</span> <span class="k">struct</span> <span class="p">{</span> 
    <span class="n">Title</span> <span class="kt">string</span>
    <span class="n">Authors</span> <span class="p">[]</span><span class="kt">string</span> 
    <span class="n">Publisher</span> <span class="kt">string</span> 
    <span class="n">IsPublished</span> <span class="kt">bool</span> <span class="n">Price</span> <span class="n">float</span>
<span class="p">}</span>

<span class="n">gobook</span> <span class="o">:=</span> <span class="n">Book</span><span class="p">{</span> <span class="s">"Go语言编程"</span><span class="p">,</span>
                <span class="p">[</span><span class="s">"XuShiwei"</span><span class="p">,</span> <span class="s">"HughLv"</span><span class="p">,</span> <span class="s">"Pandaman"</span><span class="p">,</span> <span class="s">"GuaguaSong"</span><span class="p">,</span> <span class="s">"HanTuo"</span><span class="p">,</span> <span class="s">"BertYuan"</span><span class="p">,</span> <span class="s">"XuDaoli"</span><span class="p">],</span>
                <span class="s">"ituring.com.cn"</span><span class="p">,</span> <span class="no">true</span><span class="p">,</span>
                <span class="m">9.99</span>
            <span class="p">}</span>

<span class="n">b</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">gobook</span><span class="p">)</span> <span class="c">// 将 gobook 实例生成一段 JSON 格式的文本</span>
</code></pre></div></div>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">b</span> <span class="o">==</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="s">`{
"Title": "Go语言编程",
"Authors": ["XuShiwei", "HughLv", "Pandaman", "GuaguaSong", "HanTuo", "BertYuan",
             "XuDaoli"],
         "Publisher": "ituring.com.cn",
         "IsPublished": true,
         "Price": 9.99
}`</span><span class="p">)</span>
</code></pre></div></div>

<p>Go 语言的大多数数据类型都可以转化为有效的 JSON 文本，但 channel、complex 和函数这几种类型除外。</p>

<p>如果转化前的数据结构中出现指针，那么将会转化指针所指向的值，如果指针指向的是零值， 那么 null 将作为转化后的结果输出。</p>

<p>在 Go 中，JSON 转化前后的数据类型映射如下：</p>

<ul>
  <li>布尔值转化为 JSON 后还是布尔类型。</li>
  <li>浮点数和整型会被转化为 JSON 里边的常规数字。</li>
  <li>字符串将以 UTF-8 编码转化输出为 Unicode 字符集的字符串，特殊字符比如 &lt; 将会被转义为 \u003c。</li>
  <li>数组和切片会转化为 JSON 里边的数组，但 <code class="language-plaintext highlighter-rouge">[]byte</code> 类型的值将会被转化为 Base64 编码后的字符串，slice 类型的零值会被转化为 null。</li>
  <li>结构体会转化为 JSON 对象，并且只有结构体里边以大写字母开头的可被导出的字段才会被转化输出，而这些可导出的字段会作为JSON对象的字符串索引。</li>
  <li>转化一个map类型的数据结构时，该数据的类型必须是 <code class="language-plaintext highlighter-rouge">map[string]T</code> (T 可以是 <code class="language-plaintext highlighter-rouge">encoding/json</code> 包支持的任意数据类型)。</li>
</ul>

<h2 id="32-解码-json-数据">3.2 解码 JSON 数据</h2>

<p>可以使用 <code class="language-plaintext highlighter-rouge">json.Unmarshal()</code> 函数将JSON格式的文本解码为Go里边预期的数据结构。 <code class="language-plaintext highlighter-rouge">json.Unmarshal()</code> 函数的原型如下:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">Unmarshal</span><span class="p">(</span><span class="n">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="n">v</span> <span class="k">interface</span><span class="p">{})</span> <span class="kt">error</span>
</code></pre></div></div>
<p>如：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">book</span> <span class="n">Book</span>

<span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">book</span><span class="p">)</span>

<span class="n">book</span> <span class="o">:=</span> <span class="n">Book</span><span class="p">{</span> <span class="s">"Go语言编程"</span><span class="p">,</span>
                <span class="p">[</span><span class="s">"XuShiwei"</span><span class="p">,</span> <span class="s">"HughLv"</span><span class="p">,</span> <span class="s">"Pandaman"</span><span class="p">,</span> <span class="s">"GuaguaSong"</span><span class="p">,</span> <span class="s">"HanTuo"</span><span class="p">,</span> <span class="s">"BertYuan"</span><span class="p">,</span> <span class="s">"XuDaoli"</span><span class="p">],</span>
                <span class="s">"ituring.com.cn"</span><span class="p">,</span> 
                <span class="no">true</span><span class="p">,</span>
                <span class="m">9.99</span>
            <span class="p">}</span>
</code></pre></div></div>

<h2 id="43-解码未知结构的-json-数据">4.3 解码未知结构的 JSON 数据</h2>

<p>要解码一段未知结构的 JSON，只需将这段 JSON 数据解码输出到一个空接口即可。</p>

<p>Go 的标准库 <code class="language-plaintext highlighter-rouge">encoding/json</code> 包中，允许使用 <code class="language-plaintext highlighter-rouge">map[string]interface{}</code> 和<code class="language-plaintext highlighter-rouge">[]interface{}</code> 类型的值来分别存放未知结构的 JSON 对象或数组。</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">b</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="s">`{
            "Title": "Go语言编程",
            "Authors": ["XuShiwei", "HughLv", "Pandaman", "GuaguaSong", "HanTuo", "BertYuan","XuDaoli"],
            "Publisher": "ituring.com.cn",
            "IsPublished": true,
            "Price": 9.99,
            "Sales": 1000000
}`</span><span class="p">)</span>

<span class="k">var</span> <span class="n">r</span> <span class="k">interface</span><span class="p">{}</span>
<span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)</span>
</code></pre></div></div>
<p>最终 r 将会是一个键值对的 <code class="language-plaintext highlighter-rouge">map[string]interface{}</code> 结构:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{}{</span>
    <span class="s">"Title"</span><span class="o">:</span> <span class="s">"Go语言编程"</span><span class="p">,</span>
    <span class="s">"Authors"</span><span class="o">:</span> <span class="p">[</span><span class="s">"XuShiwei"</span><span class="p">,</span> <span class="s">"HughLv"</span><span class="p">,</span> <span class="s">"Pandaman"</span><span class="p">,</span> <span class="s">"GuaguaSong"</span><span class="p">,</span> <span class="s">"HanTuo"</span><span class="p">,</span> <span class="s">"BertYuan"</span><span class="p">,</span> <span class="s">"XuDaoli"</span><span class="p">],</span>
    <span class="s">"Publisher"</span><span class="o">:</span> <span class="s">"ituring.com.cn"</span><span class="p">,</span>
    <span class="s">"IsPublished"</span><span class="o">:</span> <span class="no">true</span><span class="p">,</span>
    <span class="s">"Price"</span><span class="o">:</span> <span class="m">9.99</span><span class="p">,</span>
    <span class="s">"Sales"</span><span class="o">:</span> <span class="m">1000000</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="34-json-的流式读写">3.4 JSON 的流式读写</h2>

<p>Go 内建的 <code class="language-plaintext highlighter-rouge">encoding/json</code> 包还提供 Decoder 和 Encoder 两个类型，用于支持JSON数据的 流式读写，并提供 <code class="language-plaintext highlighter-rouge">NewDecoder()</code>和<code class="language-plaintext highlighter-rouge">NewEncoder()</code>两个函数来便于具体实现:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">NewDecoder</span><span class="p">(</span><span class="n">r</span> <span class="n">io</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span> <span class="o">*</span><span class="n">Decoder</span> 
<span class="k">func</span> <span class="n">NewEncoder</span><span class="p">(</span><span class="n">w</span> <span class="n">io</span><span class="o">.</span><span class="n">Writer</span><span class="p">)</span> <span class="o">*</span><span class="n">Encoder</span>
</code></pre></div></div>
<p>如：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span> <span class="k">import</span> <span class="p">(</span>
        <span class="s">"encoding/json"</span>
        <span class="s">"log"</span>
        <span class="s">"os"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="n">dec</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdin</span><span class="p">)</span> 
    <span class="n">enc</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">NewEncoder</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">)</span> 
    <span class="k">for</span> <span class="p">{</span>
        <span class="k">var</span> <span class="n">v</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{}</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">dec</span><span class="o">.</span><span class="n">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">k</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">v</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s">"Title"</span> <span class="p">{</span> 
                <span class="n">v</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="no">nil</span><span class="p">,</span> <span class="no">false</span>
            <span class="p">}</span> 
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">enc</span><span class="o">.</span><span class="n">Encode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span> 
            <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

  		
	  </article>
    </div>

</div>

<span>
	<a  href="/go-concurrent-programming" class="pageNav"  >上一篇</a>
	&nbsp;&nbsp;&nbsp;
	<a  href="/go-project-management" class="pageNav"  >下一篇</a>
</span>


	<div class="article-author">
    <div class="name">
        <h4><b>carlos</b> </h4>
        Just for fun!
    </div>
    <div class="avatar">
        <img width="50" height="50" src="/images/header.png" alt=" Avatar"/>
    </div>
</div>


	
	    <!--
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = '';
	(function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
	



<!--
<div class="cnzz"><script src="http://s4.cnzz.com/z_stat.php?id=1255123325&web_id=1255123325" language="JavaScript"></script> </div>
 -->

        </div>
      </div>
    </div>

    </body>
</html>
